---
layout: post
title: Comment intégrer des scripts d'utilité externe dans Logstash Pipeline
comments: true
lang: cn
ref: pipeline
thumbnail: hackergotchi_big.png
summary: This article describes the approach to call external applications from Logstash Pipeline and use their (JSON/XML/key-value) output in the further filtering process.
tags: [logstash,elasticsearch,ruby]
---

### 概观

[Logstash]（https://www.elastic.co/products/logstash）是处理日志并从中提取有价值数据的好工具。 有很多有用的Logstash
[filter plugins](https://www.elastic.co/guide/en/logstash/current/filter-plugins.html) 这使得处理原始日志数据变得容易。 但有时候
外部实用程序需要以比现有的过滤器插件更复杂的方式处理数据。

有可能 [code your own filter plugin](https://www.elastic.co/guide/en/logstash/current/_how_to_write_a_logstash_filter_plugin.html) 在Ruby中
但是如果您已经使用其他编程语言实现了过滤器并希望在Logstash中重用它，该怎么办？

在这种情况下，从Logstash更容易与外部过滤器进行通信。 本文演示了外部引入最简单的方法

应用程序进入Logstash管道：

Logstash启动外部程序，并通过命令行参数和stdin将输入数据传递给它
1.外部程序将结果以Logstash过滤器（例如JSON）所理解的任何格式写入stdout
Logstash解析外部程序的输出，并继续处理它

不用说，在性能方面不是最好的方法。
例如，如果外部应用程序的启动时间很长，您可以考虑
启动此应用程序一次（作为守护进程/服务），并使用[ØMQ]（http://en.wikipedia.org/wiki/%C3%98MQ）或其他高性能消息队列进行通信。

详细说明和使用示例如下。



##启动外部程序

我们会用 [ruby filter](https://www.elastic.co/guide/en/logstash/current/plugins-filters-ruby.html) 为了启动外部应用并捕获其输出：
{% highlight ruby %}
filter {
    # <...> <- More filters are above
    # Launching external script to make a deeper text analysis
    if [file_path] =~ /.+/ {
       ruby {
          code => 'require "open3"
                   body_path = event["file_path"]
                   cmd =  "/opt/bin/my_filter.py -f #{file_path}"
                   stdin, stdout, stderr = Open3.popen3(cmd)
                   event["process_result"] = stdout.read
                   err = stderr.read
                   if err.to_s.empty?
                     filter_matched(event)
                   else
                     event["ext_script_err_msg"] = err
                   end'
          remove_field => ["file_path"]
       }
    }
    # Parsing of the process_result is here (see the next section)
 }
{% endhighlight %}

注意：

+外部应用程序```/ opt / bin / my_filter.py``只有在````file_path```字段不为空的时候启动。 该字段应在过滤器管道中提前提取。 它是值（```＃{file_path}```）
命令行启动外部过滤器。
+ stdin句柄可访问我们的小型ruby脚本，可用于向外部程序（```/ opt / bin / my_filter.py```）发送更多数据。
+如果应用程序stderr不为空，则过滤器不被认为是成功的，并且stderr内容被记录到“ext_script_err_msg”字段中。
+如果处理成功，外部程序的输出将被记录到“process_result”文件夹中，“file_path”字段被删除

###分析外部程序的输出（JSON）

将数据传回Logstash的最简单的方法是使用Logstash过滤器了解的结构化数据格式之一：[JSON](https://www.elastic.co/guide/en/logstash/current/plugins-filters-json.html),
[XML](https://www.elastic.co/guide/en/logstash/current/plugins-filters-xml.html) 或更老式 [key-value (kv)](https://www.elastic.co/guide/en/logstash/current/plugins-filters-kv.html).


JSON示例：

{% highlight ruby %}
  if [process_result] =~ /.+/ {
       json {
          source => "process_result"
          remove_field => [ "process_result" ]
       }
    }
{% endhighlight %}

注意：

+ Field“`process_result```持有外部应用程序的输出，应该是JSON格式。
+如果解析成功，JSON字段正在成为事件字段，并且中间字段“`process_result```被删除。

###关于exec输出插件的几个字

如果您只需要在任何匹配的Logstash事件上启动外部实用程序，您可以考虑使用更简单的方法
– [exec output plugin](https://www.elastic.co/guide/en/logstash/current/plugins-outputs-exec.html).

{% include twitter_plug.html %}
